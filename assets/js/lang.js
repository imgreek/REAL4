// Language translation file for REAL Platform
const translations = {
  zh: {
    // Common
    platform_name: "REAL 平台",
    home: "首頁",
    equipment: "設備",
    learning: "學習",
    profile: "我的",
    points: "積分",
    level: "等級",
    search: "搜索",
    edit: "編輯",
    save: "保存",
    cancel: "取消",
    confirm: "確認",
    logout: "登出",
    update_info: "更新資料",
    back: "返回",
    send: "發送",
    create: "建立",
    close: "關閉",
    select: "選擇",
    basic: "基礎",
    intermediate: "進階",
    professional: "專業",
    
    // QR Scanner
    qr_scanner: "QR碼掃描",
    scan_instruction: "請將鏡頭對準設備上的QR碼，系統將自動識別",
    view_details: "查看詳情",
    borrow_now: "立即借用",
    scan_success: "掃描成功",
    scan_failed: "掃描失敗",
    camera_permission: "請允許使用相機權限",
    status: "狀態",
    available: "可借用",
    borrowed: "已借出",
    equipment_not_found: "找不到對應的設備資訊，請檢查QR碼是否正確。",
    
    // Login page
    login: "登入",
    student_account: "學生帳號",
    password: "密碼",
    password_placeholder: "輸入密碼（Demo 版可直接進入）",
    select_user: "請選擇用戶",
    demo_note: "Demo 版：任何用戶均可直接登入",
    
    // Home page
    recent_status: "借用狀態",
    no_equipment: "目前沒有借用中的設備",
    main_functions: "主要功能",
    ongoing_courses: "進行中課程",
    no_ongoing_courses: "目前沒有進行中的課程",
    continue_learning: "繼續學習",
    progress: "進度",
    completed: "已完成",
    
    // Equipment page
    equipment_rental: "設備借用",
    rental_date: "借用日期",
    select_rental_dates: "請選擇借用起始與結束日期",
    date_range: "日期範圍",
    rental_days: "借用天數",
    days: "天",
    points_calculation: "積分計算",
    your_points: "您的積分",
    required_points: "所需積分",
    points_after_rental: "借用後剩餘",
    confirm_rental: "確認借用",
    booking_success: "預訂成功",
    booking_failed: "預訂失敗",
    to: "至",
    points_deducted: "扣除積分",
    please_select_dates: "請選擇借用日期",
    equipment_not_found: "找不到設備信息",
    back_to_equipment: "返回設備頁面",
    required_level: "所需等級",
    level_warning: "您的等級不足，無法借用此設備。請先完成相關課程提升等級。",
    reserve_equipment: "預約借用",
    days_remaining: "剩餘",
    search_equipment: "搜索設備...",
    battery: "電池",
    sd_card: "記憶卡",
    equipment_category: "設備類別",
    all: "全部",
    camera: "相機",
    lens: "鏡頭",
    audio: "音頻",
    lighting: "燈光",
    gimbal: "穩定器",
    accessory: "配件",
    available_equipment: "可用設備",
    no_matching_equipment: "沒有找到匹配的設備",
    available: "可用",
    unavailable: "已借出",
    difficulty: "難度",
    points_per_day: "積分/天",
    basic_info: "基本資訊",
    brand: "品牌",
    model: "型號",
    available_dates: "可借用日期",
    rental_history: "借用記錄",
    completed_courses: "已完成課程",
    personal_preferences: "個人喜好設置",
    language: "語言",
    traditional_chinese: "繁體中文",
    english: "English",
    notifications: "通知",
    on: "開啟",
    off: "關閉",
    preferred_equipment: "偏好設備類型",
    project_deadline: "項目截止日期",
    no_rental_history: "目前沒有借用記錄",
    no_completed_courses: "目前沒有已完成的課程",
    rental_period: "借用期限",
    completion_date: "完成日期",
    points_consumed: "積分消耗",
    rented: "借用中",
    returned: "已歸還",
    my_group_members: "我的群組成員",
    project_member: "項目成員",
    no_group_members: "目前沒有群組成員",
    
    // Chat page
    chat: "聊天室",
    recent_conversations: "最近對話",
    typing: "正在輸入...",
    online: "在線",
    members: "位成員",
    chat_info: "聊天資訊",
    message_placeholder: "輸入訊息...",
    new_chat: "新建聊天",
    chat_type: "聊天類型",
    individual_chat: "個人聊天",
    group_chat: "群組聊天",
    ai_assistant: "AI 助手",
    select_contacts: "選擇聯絡人",
    select_ai: "選擇 AI 助手",
    group_name: "群組名稱",
    group_name_placeholder: "輸入群組名稱",
    create_chat: "建立聊天",
    select_at_least_one: "請選擇至少一個聯絡人",
    enter_group_name: "請輸入群組名稱",
    chat_created: "聊天已建立！在完整版本中，這將創建一個新的聊天頻道。",
    
    // 錯誤信息
    error_loading_user_data: "載入用戶資料失敗，請重試",
    error_during_booking: "預訂過程中發生錯誤，請稍後再試",
    dates_no_longer_available: "所選日期已被預訂，請選擇其他日期",
    not_enough_points: "您的積分不足以完成此預訂",
    error_loading_courses: "載入課程資訊失敗",
    
    // 設備類型
    tripod: "三腳架",
    drone: "無人機",
    profile_title: "個人中心",
    my_profile: "我的資料",
    rental_history: "借用記錄",
    completed_courses: "已完成課程",
    settings: "設定",
    personal_info: "個人資訊",
    user_id: "用戶ID",
    user_name: "用戶名稱",
    user_email: "用戶電郵",
    change_password: "更改密碼",
    preferences: "偏好設定",
    notification_settings: "通知設定",
    app_theme: "App 主題",
    light_mode: "明亮模式",
    dark_mode: "暗黑模式",
    language_settings: "語言設定",
    logout_confirm: "您確定要登出嗎？",
    no_rental_history_message: "您目前沒有任何借用記錄。",
    no_completed_courses_message: "您目前尚未完成任何課程。",
    return_date: "歸還日期",
    score: "分數",
    learning_module: "學習模組",
    scan_qr: "掃描QR碼",
    loading: "資料載入中...",
    in_progress: "進行中",
    course_content: "課程內容",
    back_to_learning: "返回學習列表",
    loading_content: "正在加載課程內容...",
    error_loading_content: "加載課程內容失敗，請稍後再試。",
    no_course_specified: "未指定課程文件。",
    error: "錯誤",
    start_learning: "開始學習",
    no_courses_filter: "此分類下暫無課程。",
    course_content_not_available: "此課程內容暫不可用或格式不支持。",
    feature_in_development: "此功能正在開發中。",
    modules: "單元",
    error_loading_database_module: "加載數據庫模塊失敗，請刷新頁面重試。",
    pending_completion: "待完成",
    switch_language: "切換語言",
    select_user_prompt: "請先選擇一個用戶",
    login_failed: "登入失敗，請檢查您的選擇或稍後重試。",
    login_error: "登入過程中發生意外錯誤，請聯繫管理員。",
    
    // Equipment page specific from recent changes
    equipment_icon: "器材圖標",
    status_in_use: "使用中",
    status_checking: "檢查中",
    status_damaged: "已損壞",
    status_unknown: "未知狀態 ({{status}})", 
    level_too_low_short: "等級不足",
    level_short: "等級",
    view_and_borrow: "查看並預約",
    available_on_date: "於 {{date}} 可借用",
    in_use_on_date: "於 {{date}} 已借出",
    status_not_available_general: "目前無法提供此設備",
    level_too_low_detailed: "您的等級 ({{currentUserLevel}}) 不足，此設備要求等級 {{reqLevel}}。請前往<a href='{{courseLink}}' class='underline text-blue-600 hover:text-blue-800'>學習中心</a>提升等級。",
    cannot_borrow: "無法預約",
    booked_on_selected_date: "此設備在 {{date}} 已被預訂。",
    no_matching_equipment_for_date: "在 {{date}} 沒有找到符合條件的設備。",
    stabilizer: "穩定器", 
    computer: "電腦",   
    tripod: "三腳架/燈架",
    communication: "通訊設備",
    monitor: "監視器",
    stroage: "儲存設備", 
    utility: "實用工具",
    video_equipment: "視訊設備", 
    status_available: "可借用",
    status_not_available: "無法借用",
    status_fully_functional: "功能正常", 
    status_missing: "遺失",
  },
  en: {
    // Common
    platform_name: "REAL Platform",
    home: "Home",
    equipment: "Equipment",
    learning: "Learning",
    profile: "Profile",
    points: "Points",
    level: "Level",
    search: "Search",
    edit: "Edit",
    save: "Save",
    cancel: "Cancel",
    confirm: "Confirm",
    logout: "Logout",
    update_info: "Update Info",
    back: "Back",
    send: "Send",
    create: "Create",
    close: "Close",
    select: "Select",
    basic: "Basic",
    intermediate: "Intermediate",
    professional: "Professional",
    
    // QR Scanner
    qr_scanner: "QR Code Scanner",
    scan_instruction: "Point the camera at a QR code on the equipment for automatic recognition",
    view_details: "View Details",
    borrow_now: "Borrow Now",
    scan_success: "Scan Successful",
    scan_failed: "Scan Failed",
    camera_permission: "Please allow camera permission",
    status: "Status",
    available: "Available",
    borrowed: "Borrowed",
    equipment_not_found: "Equipment information not found. Please check if the QR code is correct.",
    
    // Login page
    login: "Login",
    student_account: "Student Account",
    password: "Password",
    password_placeholder: "Enter password (Direct entry for Demo version)",
    select_user: "Please select a user",
    demo_note: "Demo version: Any user can login directly",
    
    // Home page
    recent_status: "Rental Status",
    no_equipment: "No equipment currently rented",
    main_functions: "Main Functions",
    ongoing_courses: "Ongoing Courses",
    no_ongoing_courses: "No ongoing courses at the moment",
    continue_learning: "Continue Learning",
    progress: "Progress",
    completed: "Completed",
    
    // Equipment page
    equipment_rental: "Equipment Rental",
    rental_date: "Rental Date",
    select_rental_dates: "Please select start and end dates for rental",
    date_range: "Date Range",
    rental_days: "Rental Days",
    days: "days",
    points_calculation: "Points Calculation",
    your_points: "Your Points",
    required_points: "Required Points",
    points_after_rental: "Remaining After Rental",
    confirm_rental: "Confirm Rental",
    booking_success: "Booking Successful",
    booking_failed: "Booking Failed",
    to: "to",
    points_deducted: "Points Deducted",
    please_select_dates: "Please select rental dates",
    equipment_not_found: "Equipment information not found",
    back_to_equipment: "Back to Equipment Page",
    required_level: "Required Level",
    level_warning: "Your level is insufficient to borrow this equipment. Please complete related courses to upgrade your level.",
    reserve_equipment: "Reserve Equipment",
    days_remaining: "Remaining",
    search_equipment: "Search equipment...",
    battery: "Battery",
    sd_card: "SD Card",
    equipment_category: "Equipment Category",
    all: "All",
    camera: "Camera",
    lens: "Lens",
    audio: "Audio",
    lighting: "Lighting",
    gimbal: "Gimbal",
    accessory: "Accessory",
    available_equipment: "Available Equipment",
    no_matching_equipment: "No matching equipment found",
    available: "Available",
    unavailable: "Unavailable",
    difficulty: "Difficulty",
    points_per_day: "Points/Day",
    basic_info: "Basic Information",
    brand: "Brand",
    model: "Model",
    available_dates: "Available Dates",
    rental_history: "Rental History",
    completed_courses: "Completed Courses",
    personal_preferences: "Personal Preferences",
    language: "Language",
    traditional_chinese: "繁體中文",
    english: "English",
    notifications: "Notifications",
    on: "On",
    off: "Off",
    preferred_equipment: "Preferred Equipment Types",
    project_deadline: "Project Deadline",
    no_rental_history: "No rental history available",
    no_completed_courses: "No completed courses available",
    rental_period: "Rental Period",
    completion_date: "Completion Date",
    points_consumed: "Points Consumed",
    rented: "Rented",
    returned: "Returned",
    my_group_members: "My Group Members",
    project_member: "Project Member",
    no_group_members: "No group members available",
    
    // Chat page
    chat: "Chat",
    recent_conversations: "Recent Conversations",
    typing: "Typing...",
    online: "Online",
    members: "members",
    chat_info: "Chat Info",
    message_placeholder: "Type a message...",
    new_chat: "New Chat",
    chat_type: "Chat Type",
    individual_chat: "Individual Chat",
    group_chat: "Group Chat",
    ai_assistant: "AI Assistant",
    select_contacts: "Select Contacts",
    select_ai: "Select AI Assistant",
    group_name: "Group Name",
    group_name_placeholder: "Enter group name",
    create_chat: "Create Chat",
    select_at_least_one: "Please select at least one contact",
    enter_group_name: "Please enter a group name",
    chat_created: "Chat created! This would create a new chat channel in the full version.",
    
    // 錯誤信息
    error_loading_user_data: "Failed to load user data, please try again",
    error_during_booking: "Error occurred during booking, please try again later",
    dates_no_longer_available: "Selected dates are no longer available, please choose other dates",
    not_enough_points: "You don't have enough points to complete this booking",
    error_loading_courses: "Failed to load course information",
    
    // 設備類型
    tripod: "Tripod",
    drone: "Drone",
    profile_title: "Profile Center",
    my_profile: "My Profile",
    rental_history: "Rental History",
    completed_courses: "Completed Courses",
    settings: "Settings",
    personal_info: "Personal Information",
    user_id: "User ID",
    user_name: "User Name",
    user_email: "User Email",
    change_password: "Change Password",
    preferences: "Preferences",
    notification_settings: "Notification Settings",
    app_theme: "App Theme",
    light_mode: "Light Mode",
    dark_mode: "Dark Mode",
    language_settings: "Language Settings",
    logout_confirm: "Are you sure you want to logout?",
    no_rental_history_message: "You currently have no rental records.",
    no_completed_courses_message: "You have not completed any courses yet.",
    return_date: "Return Date",
    score: "Score",
    learning_module: "Learning Module",
    scan_qr: "Scan QR Code",
    loading: "Loading data...",
    in_progress: "In Progress",
    course_content: "Course Content",
    back_to_learning: "Back to Learning List",
    loading_content: "Loading course content...",
    error_loading_content: "Failed to load course content. Please try again later.",
    no_course_specified: "No course file specified.",
    error: "Error",
    start_learning: "Start Learning",
    no_courses_filter: "No courses available under this filter.",
    course_content_not_available: "Course content is not available or format is not supported.",
    feature_in_development: "This feature is under development.",
    modules: "modules",
    error_loading_database_module: "Failed to load database module, please refresh the page and try again.",
    pending_completion: "Pending Completion",
    switch_language: "Switch Language",
    select_user_prompt: "Please select a user first.",
    login_failed: "Login failed. Please check your selection or try again later.",
    login_error: "An unexpected error occurred during login. Please contact an administrator.",
    
    // Equipment page specific from recent changes
    equipment_icon: "Equipment Icon",
    status_in_use: "In Use",
    status_checking: "Checking",
    status_damaged: "Damaged",
    status_unknown: "Unknown Status ({{status}})", 
    level_too_low_short: "Level Too Low",
    level_short: "Lvl.",
    view_and_borrow: "View & Borrow",
    available_on_date: "Available on {{date}}",
    in_use_on_date: "In use on {{date}}",
    status_not_available_general: "This equipment is currently unavailable.",
    level_too_low_detailed: "Your level ({{currentUserLevel}}) is not sufficient. This equipment requires level {{reqLevel}}. Please visit the <a href='{{courseLink}}' class='underline text-blue-600 hover:text-blue-800'>Learning Center</a> to level up.",
    cannot_borrow: "Cannot Borrow",
    booked_on_selected_date: "Booked on {{date}}.",
    no_matching_equipment_for_date: "No matching equipment found for {{date}}.", 
    stabilizer: "Stabilizer", 
    computer: "Computer",   
    tripod: "Tripod/Lightstand",
    communication: "Communication",
    monitor: "Monitor",
    stroage: "Storage", 
    utility: "Utility",
    video_equipment: "Video Equipment", 
    status_available: "Available",
    status_not_available: "Not Available",
    status_fully_functional: "Fully Functional", 
    status_missing: "Missing",
  }
};

// Function to get translation
function t(key, lang, options = {}) {
  let currentLang = lang || localStorage.getItem('language') || 'zh';
  
  // Fallback to 'zh' if currentLang is not a valid key in translations
  if (!translations[currentLang]) {
    // console.warn(`Language "${currentLang}" not found in translations, falling back to 'zh'.`);
    currentLang = 'zh';
  }

  let translation = '';
  // Try to get translation for the current language
  if (translations[currentLang] && typeof translations[currentLang][key] !== 'undefined') {
    translation = translations[currentLang][key];
  } else {
    // Fallback to English if current language or key is missing, and currentLang is not English
    if (currentLang !== 'en' && translations['en'] && typeof translations['en'][key] !== 'undefined') {
        // console.warn(`Key "${key}" not found for lang "${currentLang}", falling back to 'en'.`);
        translation = translations['en'][key];
    } 
    // Fallback to Chinese if English also missing or currentLang is English but key missing, and currentLang is not Chinese
    else if (currentLang !== 'zh' && translations['zh'] && typeof translations['zh'][key] !== 'undefined') {
        // console.warn(`Key "${key}" not found for lang "${currentLang}" or 'en', falling back to 'zh'.`);
        translation = translations['zh'][key];
    } else {
        // If key not found in current, en, or zh, return the key itself as a last resort
        // console.warn(`Key "${key}" not found in any configured language, returning key.`);
        translation = key;
    }
  }

  // Perform placeholder replacement
  if (typeof translation === 'string') {
    for (const placeholder in options) {
      if (Object.hasOwnProperty.call(options, placeholder)) {
        translation = translation.replace(new RegExp(`{{${placeholder}}}`, 'g'), options[placeholder]);
      }
    }
  }
  return translation;
}

// Function to switch language
function switchLanguage(lang) {
  localStorage.setItem('language', lang);
  applyTranslations(); // 直接應用翻譯，而不是刷新頁面
}

// Initialize language preference and apply translations
document.addEventListener('DOMContentLoaded', function() {
  // Set default language if not set
  if (!localStorage.getItem('language')) {
    localStorage.setItem('language', 'zh');
  }
  
  // Apply translations to the page
  applyTranslations();
  
  // 動態添加語言切換器到頁眉 (如果不存在)
  // 這段代碼可以考慮刪除或重構，因為預期切換器已在各HTML中
  const header = document.querySelector('header .flex.items-center'); // 更精準地選擇容器
  if (header && !document.getElementById('languageSwitcher')) {
    const languageSwitcher = document.createElement('button');
    languageSwitcher.id = 'languageSwitcher';
    languageSwitcher.className = 'text-white ml-2'; // 保持樣式一致性
    languageSwitcher.setAttribute('aria-label', 'Switch Language');
    
    const currentLangOnLoad = localStorage.getItem('language') || 'zh';
    languageSwitcher.innerHTML = `<i class="fas fa-globe"></i>`; // 統一使用圖標
    
    languageSwitcher.addEventListener('click', function() {
      const currentLang = localStorage.getItem('language') || 'zh';
      const newLang = currentLang === 'zh' ? 'en' : 'zh';
      switchLanguage(newLang);
    });
    // 將切換器添加到頁眉的右側控件中
    const firstChild = header.firstChild;
    if (firstChild) {
        header.insertBefore(languageSwitcher, firstChild);
    } else {
        header.appendChild(languageSwitcher);
    }
  }
});

// Function to apply translations to the page
function applyTranslations() {
  const currentLang = localStorage.getItem('language') || 'zh';
  
  // 更新頁面標題 (如果標題包含平台名稱)
  if (document.title.includes(t('platform_name', currentLang === 'zh' ? 'en' : 'zh'))) { // 使用相反語言的平台名稱來替換
      document.title = document.title.replace(t('platform_name', currentLang === 'zh' ? 'en' : 'zh'), t('platform_name', currentLang));
  } else if (document.title.includes("REAL Platform")) { // 初始英文標題
      document.title = document.title.replace("REAL Platform", t('platform_name', currentLang));
  } else if (document.title.includes("REAL 平台")) { // 初始中文標題
      document.title = document.title.replace("REAL 平台", t('platform_name', currentLang));
  }

  // 更新語言切換按鈕的 aria-label (如果存在)
  const langSwitcherButton = document.getElementById('languageSwitcher');
  if (langSwitcherButton) {
    langSwitcherButton.setAttribute('aria-label', t('switch_language', currentLang) || 'Switch Language');
    // 如果按鈕內含文字，也可以更新文字
    // e.g., langSwitcherButton.querySelector('span').textContent = t('language_switcher_text', currentLang);
  }
  
  // 更新文本內容
  document.querySelectorAll('[data-i18n]').forEach(element => {
    const key = element.getAttribute('data-i18n');
    if (key) {
      element.textContent = t(key, currentLang);
    }
  });
  
  // 更新佔位符
  document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
    const key = element.getAttribute('data-i18n-placeholder');
    if (key) {
      element.placeholder = t(key, currentLang);
    }
  });
  
  // 更新 aria-labels
  document.querySelectorAll('[data-i18n-aria]').forEach(element => {
    const key = element.getAttribute('data-i18n-aria');
    if (key) {
      element.setAttribute('aria-label', t(key, currentLang));
    }
  });

  // 更新 title 屬性
  document.querySelectorAll('[data-i18n-title]').forEach(element => {
    const key = element.getAttribute('data-i18n-title');
    if (key) {
      element.setAttribute('title', t(key, currentLang));
    }
  });
}

// 確保在所有依賴的HTML元素加載完畢後執行
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', applyTranslations);
} else {
    applyTranslations();
}